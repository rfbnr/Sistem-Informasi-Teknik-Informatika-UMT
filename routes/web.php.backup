<?php

use App\Models\Layanan;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\AuthController;
use App\Http\Controllers\HomeController;
use App\Http\Controllers\DosenController;
use App\Http\Controllers\EventController;
use App\Http\Controllers\LombaController;
use App\Http\Controllers\AlumniController;
use App\Http\Controllers\JurnalController;
use App\Http\Controllers\KaprodiController;
use App\Http\Controllers\LayananController;
use App\Http\Controllers\SorotanController;
use App\Http\Controllers\AkreditasiController;
use App\Http\Controllers\VerificationController;
use App\Http\Controllers\ApprovalRequestController;

use App\Http\Controllers\DigitalSignatureController;
use App\Http\Controllers\DocumentSignatureController;
use App\Http\Controllers\SignatureTemplateController;
use App\Http\Controllers\StrukturOrganisasiController;





// Route::get('/', function () {
//     return view('welcome');
// });
Route::get('/login', [AuthController::class, 'login'])->name('login');
Route::post('login', [AuthController::class, 'do_login']);
Route::get('/logout', [AuthController::class, 'logout']);
Route::get('/user-register', [AuthController::class, "user_register"])->name('user.register');
Route::post('/user-register', [AuthController::class, "do_user_register"])->name('do.user.register');
Route::get('/terverfikasi/disetujui/{id}', [HomeController::class, 'verif'])->name('verifikasi');

// kaprodi
// Route::prefix('kaprodi')
//     ->middleware(['auth:kaprodi'])
//     ->group(function () {
//         Route::get('/approval-requests', [ApprovalRequestController::class, 'index'])->name('approval-requests.index');
//         Route::get('/approval-requests/{id}/approve', [ApprovalRequestController::class, 'approve'])->name('approval-request.approve');
//         Route::get('/approval-requests/{id}/reject', [ApprovalRequestController::class, 'reject'])->name('approval-request.reject');
//         Route::post('/approval-requests/{id}/upload-signed-document', [ApprovalRequestController::class, 'uploadSignedDocument'])->name('approval-request.uploadSignedDocument');
//         Route::get('/approval-requests/download/{id}', [ApprovalRequestController::class, 'downloadDocument'])->name('approval-request.downloadDocument');
//     });

// mahasiswa
// Route::prefix('mahasiswa')
//     ->middleware(['auth:web'])
//     ->group(function () {
//         // Route::get('/approval-requests/upload', [ApprovalRequestController::class, 'create'])->name('approval-request.create');
//         Route::post('/approval-requests/upload', [ApprovalRequestController::class, 'upload'])->name('approval-request.upload');
//         Route::get('/status', [ApprovalRequestController::class, 'status'])->name('approval-request.status');
//     });


Route::get('/', [HomeController::class, 'index']);
Route::get('/agenda-detail/{id}', [HomeController::class, 'agenda_detail']);
Route::get('/pengabdian', [HomeController::class, 'pengabdian']);
Route::get('/download', [HomeController::class, 'download']);
Route::get('/dosen-pembimbing-akademik', [HomeController::class, 'dpa']);
Route::get('/kurikulum-rps', [HomeController::class, 'kurikulum']);
Route::get('/luaran-obe', [HomeController::class, 'luaran']);
Route::get('/lomba', [LombaController::class, 'index']);
Route::get('/penelitian', [JurnalController::class, 'index']);
Route::get('/dosen', [DosenController::class, 'index']);
Route::get('/akreditasi', [AkreditasiController::class, 'index']);
Route::get('/struktur', [StrukturOrganisasiController::class, 'index']);
Route::get('/sorotan', [SorotanController::class, 'index']);
Route::get('/alumni', [AlumniController::class, 'index']);
Route::view('/visi-misi', 'user.visi-misi');
Route::view('/sinta', 'user.sinta');
Route::get('/aproval', [ApprovalRequestController::class, 'showUploadForm']);


Route::get('events', [EventController::class, 'index'])->name('events.index');
Route::get('events/create', [EventController::class, 'create'])->name('events.create');
Route::post('events', [EventController::class, 'store'])->name('events.store');
Route::get('layanans', [LayananController::class, 'index'])->name('layanan.index');




Route::get('/approval-requests/download-signed/{id}', [ApprovalRequestController::class, 'downloadSignedDocument'])->name('approval-request.downloadSignedDocument');


// Public Verification Routes (no authentication required)
Route::prefix('signature')->name('signature.')->group(function () {
    // Public verification page
    Route::get('verify', [VerificationController::class, 'verificationPage'])->name('verify.page');

    // Verify by QR token
    Route::get('verify/{token}', [VerificationController::class, 'verifyByToken'])->name('verify');

    // Public verification form
    Route::post('verify', [VerificationController::class, 'verifyPublic'])->name('verify.public');

    // API endpoints for verification
    Route::get('api/verify/{token}', [VerificationController::class, 'getVerificationDetails'])->name('api.verify');
    Route::post('api/bulk-verify', [VerificationController::class, 'bulkVerify'])->name('api.bulk.verify');

    // Download verification certificate
    Route::get('certificate/{token}', [VerificationController::class, 'downloadCertificate'])->name('certificate');

    // Public statistics
    Route::get('api/statistics', [VerificationController::class, 'getPublicStatistics'])->name('api.statistics');
});

// Admin Routes (requires kaprodi authentication)
Route::prefix('admin/signature')
    ->middleware(['auth:kaprodi'])
    ->name('admin.signature.')
    ->group(function () {

        // Dashboard
        Route::get('dashboard', [DigitalSignatureController::class, 'adminDashboard'])->name('dashboard');

        // Key Management
        Route::get('keys', [DigitalSignatureController::class, 'keyManagement'])->name('key-management');
        Route::post('keys/create', [DigitalSignatureController::class, 'createSignatureKey'])->name('create');
        Route::get('keys/{id}', [DigitalSignatureController::class, 'viewSignatureKey'])->name('view');
        Route::post('keys/{id}/revoke', [DigitalSignatureController::class, 'revokeSignatureKey'])->name('revoke');

        // Document Signatures Management
        Route::get('documents', [DocumentSignatureController::class, 'index'])->name('documents.index');
        Route::get('documents/{id}', [DocumentSignatureController::class, 'show'])->name('documents.show');
        Route::post('documents/{id}/verify', [DocumentSignatureController::class, 'verify'])->name('documents.verify');
        Route::post('documents/{id}/invalidate', [DocumentSignatureController::class, 'invalidate'])->name('documents.invalidate');
        Route::post('documents/batch-verify', [DocumentSignatureController::class, 'batchVerify'])->name('documents.batch.verify');

        // Downloads
        Route::get('documents/{id}/download', [DocumentSignatureController::class, 'downloadSignedDocument'])->name('documents.download');
        Route::get('documents/{id}/qr-code', [DocumentSignatureController::class, 'downloadQRCode'])->name('documents.qr.download');
        Route::post('documents/{id}/regenerate-qr', [DocumentSignatureController::class, 'regenerateQRCode'])->name('documents.qr.regenerate');

        // Template Management
        Route::get('templates', [SignatureTemplateController::class, 'index'])->name('templates.index');
        Route::get('templates/create', [SignatureTemplateController::class, 'create'])->name('templates.create');
        Route::post('templates', [SignatureTemplateController::class, 'store'])->name('templates.store');
        Route::get('templates/{id}', [SignatureTemplateController::class, 'show'])->name('templates.show');
        Route::get('templates/{id}/edit', [SignatureTemplateController::class, 'edit'])->name('templates.edit');
        Route::put('templates/{id}', [SignatureTemplateController::class, 'update'])->name('templates.update');
        Route::delete('templates/{id}', [SignatureTemplateController::class, 'destroy'])->name('templates.destroy');
        Route::post('templates/{id}/set-default', [SignatureTemplateController::class, 'setDefault'])->name('templates.set.default');

        // Verification Tools
        Route::get('verification-tools', [DigitalSignatureController::class, 'verificationTools'])->name('verification-tools');
        Route::post('manual-verify', [DigitalSignatureController::class, 'manualVerification'])->name('manual.verify');

        // Export & Statistics
        Route::get('export', [DigitalSignatureController::class, 'exportStatistics'])->name('export');
        Route::get('documents/export', [DocumentSignatureController::class, 'export'])->name('documents.export');
        Route::get('statistics', [DocumentSignatureController::class, 'getStatistics'])->name('statistics');

        // Development/Testing Routes (only in local environment)
        // Route::when('local', function () {
        //     Route::post('test/generate', [DigitalSignatureController::class, 'generateTestSignature'])->name('test.generate');
        // });
    });

// User Routes (requires web authentication)
Route::prefix('mahasiswa/signature')
    ->middleware(['auth:web'])
    ->name('user.signature.')
    ->group(function () {

        // Document Signing
        Route::get('sign/{approvalRequestId}', [DigitalSignatureController::class, 'signDocument'])->name('sign');
        Route::get('canvas/{approvalRequestId}', [DigitalSignatureController::class, 'signatureCanvas'])->name('canvas');
        Route::post('process/{approvalRequestId}', [DigitalSignatureController::class, 'processDocumentSigning'])->name('process');

        // My Signatures
        Route::get('my-signatures', [DocumentSignatureController::class, 'userSignatures'])->name('my.signatures');
        Route::get('my-signatures/{id}', [DocumentSignatureController::class, 'userSignatureDetails'])->name('my.signatures.show');
        Route::get('my-signatures/{id}/download', [DocumentSignatureController::class, 'downloadSignedDocument'])->name('my.signatures.download');
        Route::get('my-signatures/{id}/qr-code', [DocumentSignatureController::class, 'downloadQRCode'])->name('my.signatures.qr');
    });

// Enhanced Approval Request Routes (integrating with digital signature)
Route::prefix('approval-requests')
    ->name('approval-request.')
    ->group(function () {

        // Public verification route (accessible without login)
        Route::get('verify/{encryptedId}', [ApprovalRequestController::class, 'verifyDocument'])
            ->name('verify.document');

        // Kaprodi routes
        Route::middleware(['auth:kaprodi'])->group(function () {
            Route::get('/', [ApprovalRequestController::class, 'index'])->name('index');
            Route::get('{id}/approve', [ApprovalRequestController::class, 'approve'])->name('approve');
            Route::get('{id}/reject', [ApprovalRequestController::class, 'reject'])->name('reject');
            Route::post('{id}/upload-signed-document', [ApprovalRequestController::class, 'uploadSignedDocument'])
                ->name('uploadSignedDocument');
            Route::get('download/{id}', [ApprovalRequestController::class, 'downloadDocument'])
                ->name('downloadDocument');

            // Enhanced signature workflow
            Route::post('{id}/approve-signature', [ApprovalRequestController::class, 'approveSignature'])
                ->name('approve.signature');
            Route::post('{id}/reject-signature', [ApprovalRequestController::class, 'rejectSignature'])
                ->name('reject.signature');
        });

        // Student routes
        Route::middleware(['auth:web'])->group(function () {
            Route::post('upload', [ApprovalRequestController::class, 'upload'])->name('upload');
            Route::get('status', [ApprovalRequestController::class, 'status'])->name('status');
            Route::get('{id}/sign', [DigitalSignatureController::class, 'signDocument'])->name('sign');
        });

        // Download signed documents (authenticated users only)
        Route::get('download-signed/{id}', [ApprovalRequestController::class, 'downloadSignedDocument'])
            ->name('downloadSignedDocument')
            ->middleware('auth:web,kaprodi');
    });

// API Routes untuk external integrations
Route::prefix('api/signature')
    ->middleware('api')
    ->name('api.signature.')
    ->group(function () {

        // Rate limited public API
        Route::middleware('throttle:api')->group(function () {
            Route::post('verify', [VerificationController::class, 'verifyPublic']);
            Route::get('status/{token}', [VerificationController::class, 'getVerificationDetails']);
        });

        // Authenticated API (requires API key)
        Route::middleware('auth.api.key')->group(function () {
            Route::post('create-signature', [DigitalSignatureController::class, 'createSignatureAPI']);
            Route::post('sign-document', [DigitalSignatureController::class, 'signDocumentAPI']);
            Route::get('statistics', [DocumentSignatureController::class, 'getStatisticsAPI']);
        });
    });

// Webhook Routes untuk external notifications
Route::prefix('webhooks/signature')
    ->middleware('verify.webhook.signature')
    ->name('webhook.signature.')
    ->group(function () {
        Route::post('document-signed', [DocumentSignatureController::class, 'handleDocumentSigned']);
        Route::post('verification-completed', [VerificationController::class, 'handleVerificationCompleted']);
        Route::post('signature-expired', [DigitalSignatureController::class, 'handleSignatureExpired']);
    });

// Legacy routes compatibility (untuk backward compatibility)
Route::get('terverfikasi/disetujui/{id}', [ApprovalRequestController::class, 'verifyLegacy'])
    ->name('verifikasi');


// Route untuk testing (hanya development)
if (app()->environment('local', 'staging')) {
    Route::prefix('dev/signature')
        ->name('dev.signature.')
        ->group(function () {
            Route::get('test-canvas', function () {
                return view('digital-signature.dev.test-canvas');
            })->name('test.canvas');

            Route::get('test-verification/{token}', [VerificationController::class, 'testVerification'])
                ->name('test.verification');

            Route::post('generate-test-data', [DigitalSignatureController::class, 'generateTestData'])
                ->name('generate.test.data');
        });
}











@push('scripts')
<script>
$(document).ready(function() {
    // Debug: Log when document is ready
    console.log('Document ready, initializing form...');

    // Priority selection
    $('.priority-option').click(function() {
        $('.priority-option').removeClass('active');
        $(this).addClass('active');
        const radioId = $(this).attr('for');
        $('#' + radioId).prop('checked', true);
        console.log('Priority selected:', $('#' + radioId).val());
    });

    // Set initial active priority
    $('input[name="priority"]:checked').each(function() {
        $('label[for="' + this.id + '"]').addClass('active');
    });

    // File upload handling
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('document');
    const fileInfo = document.getElementById('fileInfo');
    const fileError = document.getElementById('fileError');

    console.log('File input element:', fileInput);
    console.log('Dropzone element:', dropzone);

    // Drag and drop events
    if (dropzone && fileInput) {
        dropzone.addEventListener('dragover', handleDragOver);
        dropzone.addEventListener('dragleave', handleDragLeave);
        dropzone.addEventListener('drop', handleDrop);
        dropzone.addEventListener('click', triggerFileInput);
        fileInput.addEventListener('change', handleFileSelect);
    }

    function handleDragOver(e) {
        e.preventDefault();
        dropzone.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        dropzone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    }

    function handleFileSelect() {
        console.log('File selected, processing...');
        const file = fileInput.files[0];

        if (file) {
            console.log('File details:', {
                name: file.name,
                type: file.type,
                size: file.size
            });

            // Clear previous errors
            hideFileError();

            // Validate file type
            if (file.type !== 'application/pdf') {
                showFileError('Please select a PDF file only.');
                fileInput.value = '';
                return;
            }

            // Validate file size (25MB = 26214400 bytes)
            if (file.size > 26214400) {
                showFileError('File size must be less than 25MB.');
                fileInput.value = '';
                return;
            }

            showFileInfo(file);
        }
    }

    function showFileInfo(file) {
        const fileSize = formatFileSize(file.size);
        fileInfo.innerHTML = `
            <div class="alert alert-success">
                <div class="d-flex align-items-center">
                    <i class="fas fa-file-pdf text-danger fa-2x me-3"></i>
                    <div class="flex-grow-1">
                        <strong>${file.name}</strong><br>
                        <small>${fileSize} • PDF Document</small>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFile()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        fileInfo.style.display = 'block';
        dropzone.classList.add('file-selected');
        dropzone.innerHTML = `
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">File Selected</h5>
            <p class="text-muted">${file.name}</p>
            <button type="button" class="btn btn-outline-primary" onclick="triggerFileInput()">
                <i class="fas fa-exchange-alt me-1"></i> Change File
            </button>
        `;
    }

    function showFileError(message) {
        fileError.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
        fileError.style.display = 'block';
    }

    function hideFileError() {
        fileError.style.display = 'none';
    }

    // Form submission dengan validasi lengkap
    $('#uploadForm').on('submit', function(e) {
        console.log('Form submission triggered');
        let isValid = true;
        let errors = [];

        // Debug: Log form data
        const formData = new FormData(this);
        console.log('Form data entries:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }

        // Validation checks
        if (!$('#document_name').val()) {
            errors.push('Please select a document type.');
            isValid = false;
        }

        if (!fileInput.files || !fileInput.files[0]) {
            errors.push('Please upload a document.');
            isValid = false;
        } else {
            console.log('File validation passed:', fileInput.files[0].name);
        }

        if (!$('#notes').val().trim()) {
            if (!confirm('No description provided. Continue anyway?')) {
                isValid = false;
            }
        }

        if (!isValid) {
            e.preventDefault();
            console.log('Form validation failed:', errors);
            showAlert(errors.join('<br>'), 'danger');
        } else {
            console.log('Form validation passed, submitting...');
            // Show loading state
            $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Submitting...');
        }
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        // Remove existing alerts
        $('.alert').remove();

        // Add new alert at the top of the form
        $('.upload-container').prepend(alertHtml);

        // Auto-hide after 5 seconds
        setTimeout(() => $('.alert').fadeOut(), 5000);
    }
});

// Global functions - DIPERBAIKI
function triggerFileInput() {
    console.log('Triggering file input...');
    document.getElementById('document').click();
}

function removeFile() {
    console.log('Removing file...');
    // FIXED: Menggunakan ID yang benar
    const fileInput = document.getElementById('document'); // ✅ BENAR!
    const dropzone = document.getElementById('dropzone');
    const fileInfo = document.getElementById('fileInfo');
    const fileError = document.getElementById('fileError');

    if (fileInput) {
        fileInput.value = '';
        console.log('File input cleared');
    }

    if (fileInfo) {
        fileInfo.style.display = 'none';
    }

    if (fileError) {
        fileError.style.display = 'none';
    }

    if (dropzone) {
        dropzone.classList.remove('file-selected');

        // Reset dropzone content
        dropzone.innerHTML = `
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <h5>Drop your PDF file here</h5>
            <p class="text-muted mb-3">or click to browse files</p>
            <button type="button" class="btn btn-outline-primary" onclick="triggerFileInput()">
                <i class="fas fa-folder-open me-1"></i> Choose File
            </button>
            <div class="mt-2">
                <small class="text-muted">
                    Maximum file size: 25MB • PDF format only
                </small>
            </div>
        `;
    }
}

function resetForm() {
    console.log('Resetting form...');
    document.getElementById('uploadForm').reset();
    removeFile();
    $('.priority-option').removeClass('active');
    $('#priority-normal').prop('checked', true);
    $('label[for="priority-normal"]').addClass('active');

    // Reset submit button
    $('#submitBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i> Submit Request');
}
</script>
@endpush
