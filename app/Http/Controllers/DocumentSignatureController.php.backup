<?php

namespace App\Http\Controllers;

use App\Models\ApprovalRequest;
use App\Models\DocumentSignature;
use App\Models\DigitalSignature;
use App\Models\SignatureTemplate;
use App\Models\SignatureAuditLog;
use App\Models\SignatureVerificationLog;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Crypt;
use Endroid\QrCode\QrCode;
use Endroid\QrCode\Writer\PngWriter;

class DocumentSignatureController extends Controller
{
    /**
     * Initiate signing process untuk dokumen yang sudah approved
     */
    public function initiateSigningProcess($approvalRequestId)
    {
        try {
            $approvalRequest = ApprovalRequest::findOrFail($approvalRequestId);

            // Check permission - hanya user yang buat request yang bisa sign
            if ($approvalRequest->user_id !== Auth::id()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to sign this document'
                ], 403);
            }

            // Check status - harus sudah approved
            if (!$approvalRequest->canBeSignedByUser()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Document is not ready for signing. Current status: ' . $approvalRequest->status_label
                ], 400);
            }

            // Check if DocumentSignature already exists
            if ($approvalRequest->documentSignature) {
                return response()->json([
                    'success' => true,
                    'message' => 'Signing process already initiated',
                    'data' => [
                        'document_signature_id' => $approvalRequest->documentSignature->id,
                        'verification_url' => $approvalRequest->documentSignature->verification_url,
                        'status' => $approvalRequest->documentSignature->signature_status
                    ]
                ]);
            }

            // Create DocumentSignature record
            $documentSignature = $approvalRequest->createDocumentSignature();

            return response()->json([
                'success' => true,
                'message' => 'Signing process initiated successfully',
                'data' => [
                    'document_signature_id' => $documentSignature->id,
                    'verification_url' => $documentSignature->verification_url,
                    'verification_token' => $documentSignature->verification_token,
                    'status' => $documentSignature->signature_status,
                    'document_hash' => $documentSignature->document_hash
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Signing process initiation failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to initiate signing process: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Render signing canvas dengan template
     */
    public function renderSigningCanvas($documentSignatureId)
    {
        try {
            $documentSignature = DocumentSignature::with(['approvalRequest.user', 'digitalSignature'])
                ->findOrFail($documentSignatureId);

            // Check permission
            if ($documentSignature->signed_by !== Auth::id()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to access this signing canvas'
                ], 403);
            }

            // Check status
            if ($documentSignature->signature_status !== DocumentSignature::STATUS_PENDING) {
                return response()->json([
                    'success' => false,
                    'message' => 'Document is not in pending status for signing'
                ], 400);
            }

            // Get default template (atau template yang dipilih user)
            $template = SignatureTemplate::active()->default()->first();

            if (!$template) {
                return response()->json([
                    'success' => false,
                    'message' => 'No signature template available'
                ], 404);
            }

            // Generate canvas data
            $canvasData = $template->generateCanvasData($documentSignature);

            return response()->json([
                'success' => true,
                'data' => [
                    'document_signature_id' => $documentSignature->id,
                    'canvas_data' => $canvasData,
                    'document_info' => [
                        'name' => $documentSignature->approvalRequest->document_name,
                        'number' => $documentSignature->approvalRequest->full_document_number,
                        'user_name' => $documentSignature->approvalRequest->user->name,
                        'user_nim' => $documentSignature->approvalRequest->user->NIM ?? 'N/A'
                    ]
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Signing canvas rendering failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to render signing canvas: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Process signature digital + barcode
     */
    public function processSignature(Request $request, $documentSignatureId)
    {
        try {
            $validator = Validator::make($request->all(), [
                'canvas_data_url' => 'required|string', // Base64 canvas data
                'positioning_data' => 'required|array',
                'positioning_data.barcode' => 'required|array',
                'positioning_data.signature' => 'required|array',
                'positioning_data.text' => 'required|array'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'errors' => $validator->errors()
                ], 422);
            }

            $documentSignature = DocumentSignature::with(['approvalRequest', 'digitalSignature'])
                ->findOrFail($documentSignatureId);

            // Check permission
            if ($documentSignature->signed_by !== Auth::id()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to sign this document'
                ], 403);
            }

            // Check status
            if ($documentSignature->signature_status !== DocumentSignature::STATUS_PENDING) {
                return response()->json([
                    'success' => false,
                    'message' => 'Document is not in pending status for signing'
                ], 400);
            }

            // Save canvas data
            $canvasPath = $documentSignature->saveCanvasData(
                $request->canvas_data_url,
                $request->positioning_data
            );

            // Generate QR Code
            $qrCodePath = $this->generateQRCode($documentSignature);

            // Read original document untuk create CMS signature
            $originalDocumentPath = storage_path('app/' . $documentSignature->approvalRequest->document_path);
            $documentContent = file_get_contents($originalDocumentPath);

            // Create CMS signature
            $cmsSignature = $documentSignature->createCMSSignature(
                $documentContent,
                $documentSignature->digitalSignature->private_key
            );

            // Update document signature dengan QR code path
            $documentSignature->update(['qr_code_path' => $qrCodePath]);

            // Update approval request status
            $documentSignature->approvalRequest->markUserSigned();

            return response()->json([
                'success' => true,
                'message' => 'Document signed successfully',
                'data' => [
                    'document_signature_id' => $documentSignature->id,
                    'signature_status' => $documentSignature->signature_status,
                    'signed_at' => $documentSignature->signed_at->toISOString(),
                    'verification_url' => $documentSignature->verification_url,
                    'verification_token' => $documentSignature->verification_token,
                    'qr_code_url' => Storage::url($qrCodePath),
                    'canvas_data_url' => Storage::url($canvasPath)
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Document signing failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to sign document: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Verify signature keabsahan (public endpoint)
     */
    public function verifySignature($token)
    {
        try {
            // Decrypt token untuk mendapatkan approval request ID
            $decryptedData = Crypt::decryptString($token);
            $parts = explode('|', $decryptedData);
            $approvalRequestId = $parts[0];

            $approvalRequest = ApprovalRequest::with(['documentSignature.digitalSignature', 'user'])
                ->findOrFail($approvalRequestId);

            $documentSignature = $approvalRequest->documentSignature;

            if (!$documentSignature) {
                return view('verification.result', [
                    'success' => false,
                    'message' => 'No digital signature found for this document'
                ]);
            }

            // Log verification attempt
            // SignatureVerificationLog::create([
            //     'document_signature_id' => $documentSignature->id,
            //     'verification_token' => $documentSignature->verification_token,
            //     'ip_address' => request()->ip(),
            //     'user_agent' => request()->userAgent(),
            //     'verification_result' => true, // Initial assumption
            //     'verification_details' => 'Public verification accessed',
            //     'verification_method' => SignatureVerificationLog::METHOD_QR_SCAN,
            //     'verified_at' => now()
            // ]);

            // Verify CMS signature
            $originalDocumentPath = storage_path('app/' . $approvalRequest->document_path);

            if (!file_exists($originalDocumentPath)) {
                return view('verification.result', [
                    'success' => false,
                    'message' => 'Original document not found for verification'
                ]);
            }

            $documentContent = file_get_contents($originalDocumentPath);
            $isValid = $documentSignature->verifyCMSSignature(
                $documentContent,
                $documentSignature->digitalSignature->public_key
            );

            $signatureInfo = $documentSignature->getSignatureInfo();

            return view('verification.result', [
                'success' => $isValid,
                'signature_info' => $signatureInfo,
                'verification_details' => [
                    'verified_at' => now()->format('d F Y H:i:s'),
                    'verification_method' => 'QR Code Scan',
                    'document_hash' => $documentSignature->document_hash,
                    'algorithm' => $documentSignature->digitalSignature->algorithm,
                    'key_fingerprint' => $documentSignature->digitalSignature->getPublicKeyFingerprint()
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Signature verification failed: ' . $e->getMessage());

            // Log failed verification
            // SignatureVerificationLog::create([
            //     'document_signature_id' => null,
            //     'verification_token' => $token,
            //     'ip_address' => request()->ip(),
            //     'user_agent' => request()->userAgent(),
            //     'verification_result' => false,
            //     'verification_details' => 'Verification error: ' . $e->getMessage(),
            //     'verification_method' => SignatureVerificationLog::METHOD_QR_SCAN,
            //     'verified_at' => now()
            // ]);

            return view('verification.result', [
                'success' => false,
                'message' => 'Signature verification failed: ' . $e->getMessage()
            ]);
        }
    }

    /**
     * Download dokumen yang sudah ditandatangani
     */
    public function downloadSignedDocument($documentSignatureId)
    {
        try {
            $documentSignature = DocumentSignature::with('approvalRequest')
                ->findOrFail($documentSignatureId);

            // Check permission
            $user = Auth::user();
            if ($documentSignature->signed_by !== $user->id &&
                $documentSignature->approvalRequest->approved_by !== $user->id &&
                $user->role !== 'admin') {
                abort(404, 'Signed document not found');
            }

        } catch (\Exception $e) {
            Log::error('Signed document download failed: ' . $e->getMessage());
            abort(500, 'Failed to download signed document');
        }
    }

    /**
     * Regenerate verification token untuk security
     */
    public function regenerateVerificationToken($documentSignatureId)
    {
        try {
            $documentSignature = DocumentSignature::findOrFail($documentSignatureId);

            // Check permission - only signer atau admin
            if ($documentSignature->signed_by !== Auth::id() && Auth::user()->role !== 'admin') {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to regenerate verification token'
                ], 403);
            }

            $newToken = $documentSignature->regenerateVerificationToken();

            // Generate new QR code dengan URL baru
            $qrCodePath = $this->generateQRCode($documentSignature);
            $documentSignature->update(['qr_code_path' => $qrCodePath]);

            return response()->json([
                'success' => true,
                'message' => 'Verification token regenerated successfully',
                'data' => [
                    'verification_token' => $newToken,
                    'verification_url' => $documentSignature->verification_url,
                    'qr_code_url' => Storage::url($qrCodePath),
                    'regenerated_at' => now()->toISOString()
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Token regeneration failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to regenerate verification token: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get signature details untuk admin
     */
    public function show($documentSignatureId)
    {
        try {
            $documentSignature = DocumentSignature::with([
                'approvalRequest.user',
                'digitalSignature',
                'signer',
                'verifier',
                'auditLogs.user'
            ])->findOrFail($documentSignatureId);

            // Check permission
            $user = Auth::user();
            if ($documentSignature->signed_by !== $user->id &&
                $documentSignature->approvalRequest->approved_by !== $user->id &&
                $user->role !== 'admin') {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to view signature details'
                ], 403);
            }

            return response()->json([
                'success' => true,
                'data' => [
                    'id' => $documentSignature->id,
                    'signature_status' => $documentSignature->signature_status,
                    'status_label' => $documentSignature->getStatusLabel(),
                    'document_hash' => $documentSignature->document_hash,
                    'signed_at' => $documentSignature->signed_at?->toISOString(),
                    'verified_at' => $documentSignature->verified_at?->toISOString(),
                    'verification_url' => $documentSignature->verification_url,
                    'qr_code_url' => $documentSignature->qr_code_path ? Storage::url($documentSignature->qr_code_path) : null,
                    'canvas_data_url' => $documentSignature->canvas_data_path ? Storage::url($documentSignature->canvas_data_path) : null,
                    'approval_request' => [
                        'id' => $documentSignature->approvalRequest->id,
                        'document_name' => $documentSignature->approvalRequest->document_name,
                        'document_number' => $documentSignature->approvalRequest->full_document_number,
                        'user_name' => $documentSignature->approvalRequest->user->name,
                        'status' => $documentSignature->approvalRequest->status
                    ],
                    'digital_signature' => [
                        'signature_id' => $documentSignature->digitalSignature->signature_id,
                        'algorithm' => $documentSignature->digitalSignature->algorithm,
                        'key_length' => $documentSignature->digitalSignature->key_length,
                        'public_key_fingerprint' => $documentSignature->digitalSignature->getPublicKeyFingerprint()
                    ],
                    'audit_logs' => $documentSignature->auditLogs->map(function ($log) {
                        return [
                            'action' => $log->action,
                            'action_label' => $log->action_label,
                            'description' => $log->description,
                            'user_name' => $log->user->name,
                            'performed_at' => $log->performed_at->toISOString()
                        ];
                    })
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Signature details retrieval failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve signature details: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Generate QR Code untuk verification URL
     */
    private function generateQRCode(DocumentSignature $documentSignature)
    {
        try {
            // Pastikan direktori QR codes ada
            $qrCodeDirectory = storage_path('app/public/qrcodes');
            if (!file_exists($qrCodeDirectory)) {
                mkdir($qrCodeDirectory, 0755, true);
            }

            // Generate QR code
            $qrCode = new QrCode($documentSignature->verification_url);
            $qrCode->setSize(300);
            $qrCode->setMargin(10);

            $writer = new PngWriter();
            $qrCodePath = 'qrcodes/signature_' . $documentSignature->id . '_' . time() . '.png';
            $fullPath = storage_path('app/public/' . $qrCodePath);

            $writer->write($qrCode)->saveToFile($fullPath);

            return $qrCodePath;

        } catch (\Exception $e) {
            Log::error('QR Code generation failed: ' . $e->getMessage());
            throw $e;
        }
    }

    /**
     * Batch verify multiple signatures
     */
    public function batchVerify(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'document_signature_ids' => 'required|array|min:1',
                'document_signature_ids.*' => 'required|integer|exists:document_signatures,id'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'errors' => $validator->errors()
                ], 422);
            }

            $results = [];

            foreach ($request->document_signature_ids as $id) {
                $documentSignature = DocumentSignature::with(['approvalRequest', 'digitalSignature'])
                    ->find($id);

                if (!$documentSignature) {
                    $results[] = [
                        'id' => $id,
                        'success' => false,
                        'message' => 'Document signature not found'
                    ];
                    continue;
                }

                try {
                    // Read original document
                    $originalDocumentPath = storage_path('app/' . $documentSignature->approvalRequest->document_path);

                    if (!file_exists($originalDocumentPath)) {
                        $results[] = [
                            'id' => $id,
                            'success' => false,
                            'message' => 'Original document not found'
                        ];
                        continue;
                    }

                    $documentContent = file_get_contents($originalDocumentPath);
                    $isValid = $documentSignature->verifyCMSSignature(
                        $documentContent,
                        $documentSignature->digitalSignature->public_key
                    );

                    $results[] = [
                        'id' => $id,
                        'success' => $isValid,
                        'signature_status' => $documentSignature->signature_status,
                        'verified_at' => now()->toISOString(),
                        'document_name' => $documentSignature->approvalRequest->document_name
                    ];

                } catch (\Exception $e) {
                    $results[] = [
                        'id' => $id,
                        'success' => false,
                        'message' => 'Verification failed: ' . $e->getMessage()
                    ];
                }
            }

            return response()->json([
                'success' => true,
                'message' => 'Batch verification completed',
                'results' => $results,
                'summary' => [
                    'total' => count($results),
                    'successful' => count(array_filter($results, fn($r) => $r['success'])),
                    'failed' => count(array_filter($results, fn($r) => !$r['success']))
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Batch verification failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Batch verification failed: ' . $e->getMessage()
            ], 500);
        }
    }
}
