<?php

namespace App\Http\Controllers;

use App\Models\DigitalSignature;
use App\Models\SignatureAuditLog;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;

class DigitalSignatureController extends Controller
{
    /**
     * Display dashboard management digital signatures
     */
    public function index()
    {
        $signatures = DigitalSignature::with('creator')
            ->latest()
            ->paginate(10);

        $statistics = [
            'total_signatures' => DigitalSignature::count(),
            'active_signatures' => DigitalSignature::active()->count(),
            'expired_signatures' => DigitalSignature::where('status', DigitalSignature::STATUS_EXPIRED)->count(),
            'revoked_signatures' => DigitalSignature::where('status', DigitalSignature::STATUS_REVOKED)->count(),
            'expiring_soon' => DigitalSignature::expiringSoon(30)->count(),
        ];

        return view('admin.digital-signatures.index', compact('signatures', 'statistics'));
    }

    /**
     * Generate new RSA key pair
     */
    public function generateKeyPair(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'key_length' => 'required|integer|in:2048,3072,4096',
                'purpose' => 'required|string|max:255',
                'validity_years' => 'required|integer|min:1|max:10'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'errors' => $validator->errors()
                ], 422);
            }

            $keyPair = DigitalSignature::generateKeyPair($request->key_length);

            return response()->json([
                'success' => true,
                'message' => 'RSA key pair generated successfully',
                'data' => [
                    'public_key_fingerprint' => hash('sha256', $keyPair['public_key']),
                    'key_length' => $keyPair['key_length'],
                    'generated_at' => now()->toISOString()
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Key pair generation failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to generate key pair: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Create new digital signature dengan auto key generation
     */
    public function createSignature(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'purpose' => 'required|string|max:255',
                'validity_years' => 'required|integer|min:1|max:10',
                'key_length' => 'required|integer|in:2048,3072,4096'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'errors' => $validator->errors()
                ], 422);
            }

            // Check if user already has active signature
            $existingSignature = DigitalSignature::where('created_by', Auth::id())
                ->active()
                ->valid()
                ->first();

            if ($existingSignature) {
                return response()->json([
                    'success' => false,
                    'message' => 'You already have an active digital signature. Please revoke the existing one first.'
                ], 409);
            }

            $digitalSignature = DigitalSignature::createSignature(
                $request->purpose,
                Auth::id(),
                $request->validity_years
            );

            // Log audit
            SignatureAuditLog::create([
                'user_id' => Auth::id(),
                'action' => SignatureAuditLog::ACTION_SIGNATURE_KEY_GENERATED,
                'description' => "New digital signature created with purpose: {$request->purpose}",
                'metadata' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'purpose' => $request->purpose,
                    'validity_years' => $request->validity_years,
                    'key_length' => $digitalSignature->key_length
                ],
                'ip_address' => request()->ip(),
                'user_agent' => request()->userAgent(),
                'performed_at' => now()
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Digital signature created successfully',
                'data' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'public_key_fingerprint' => $digitalSignature->getPublicKeyFingerprint(),
                    'valid_from' => $digitalSignature->valid_from->toISOString(),
                    'valid_until' => $digitalSignature->valid_until->toISOString(),
                    'algorithm' => $digitalSignature->algorithm,
                    'key_length' => $digitalSignature->key_length
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Digital signature creation failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to create digital signature: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Revoke signature yang tidak valid
     */
    public function revokeSignature(Request $request, $signatureId)
    {
        try {
            $validator = Validator::make($request->all(), [
                'reason' => 'required|string|max:500'
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'success' => false,
                    'errors' => $validator->errors()
                ], 422);
            }

            $digitalSignature = DigitalSignature::where('signature_id', $signatureId)->firstOrFail();

            // Check permission - only creator or admin can revoke
            if ($digitalSignature->created_by !== Auth::id() && Auth::user()->role !== 'admin') {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to revoke this signature'
                ], 403);
            }

            if ($digitalSignature->status === DigitalSignature::STATUS_REVOKED) {
                return response()->json([
                    'success' => false,
                    'message' => 'Signature is already revoked'
                ], 409);
            }

            $digitalSignature->revoke($request->reason);

            return response()->json([
                'success' => true,
                'message' => 'Digital signature revoked successfully',
                'data' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'revoked_at' => now()->toISOString(),
                    'reason' => $request->reason
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Signature revocation failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to revoke signature: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Validate existing key pairs
     */
    public function validateKeyPair($signatureId)
    {
        try {
            $digitalSignature = DigitalSignature::where('signature_id', $signatureId)->firstOrFail();

            // Check permission
            if ($digitalSignature->created_by !== Auth::id() && Auth::user()->role !== 'admin') {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to validate this signature'
                ], 403);
            }

            $isValid = $digitalSignature->validateKeyPair();

            // Log audit
            SignatureAuditLog::create([
                'user_id' => Auth::id(),
                'action' => 'signature_key_validated',
                'description' => "Key pair validation performed for signature: {$digitalSignature->signature_id}",
                'metadata' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'validation_result' => $isValid,
                    'algorithm' => $digitalSignature->algorithm
                ],
                'ip_address' => request()->ip(),
                'user_agent' => request()->userAgent(),
                'performed_at' => now()
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Key pair validation completed',
                'data' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'is_valid' => $isValid,
                    'algorithm' => $digitalSignature->algorithm,
                    'key_length' => $digitalSignature->key_length,
                    'validated_at' => now()->toISOString()
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Key pair validation failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to validate key pair: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get usage statistics untuk signature
     */
    public function getUsageStats($signatureId)
    {
        try {
            $digitalSignature = DigitalSignature::where('signature_id', $signatureId)->firstOrFail();

            // Check permission
            if ($digitalSignature->created_by !== Auth::id() && Auth::user()->role !== 'admin') {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to view signature statistics'
                ], 403);
            }

            $stats = $digitalSignature->getUsageStats();

            return response()->json([
                'success' => true,
                'data' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'statistics' => $stats,
                    'signature_info' => [
                        'algorithm' => $digitalSignature->algorithm,
                        'key_length' => $digitalSignature->key_length,
                        'status' => $digitalSignature->status,
                        'valid_from' => $digitalSignature->valid_from->toISOString(),
                        'valid_until' => $digitalSignature->valid_until->toISOString(),
                        'is_valid' => $digitalSignature->isValid(),
                        'is_expiring_soon' => $digitalSignature->isExpiringSoon()
                    ]
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Usage stats retrieval failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve usage statistics: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get signature details
     */
    public function show($signatureId)
    {
        try {
            $digitalSignature = DigitalSignature::where('signature_id', $signatureId)
                ->with(['creator', 'documentSignatures'])
                ->firstOrFail();

            // Check permission
            if ($digitalSignature->created_by !== Auth::id() && Auth::user()->role !== 'admin') {
                return response()->json([
                    'success' => false,
                    'message' => 'Unauthorized to view this signature'
                ], 403);
            }

            return response()->json([
                'success' => true,
                'data' => [
                    'signature_id' => $digitalSignature->signature_id,
                    'algorithm' => $digitalSignature->algorithm,
                    'key_length' => $digitalSignature->key_length,
                    'status' => $digitalSignature->status,
                    'purpose' => $digitalSignature->signature_purpose,
                    'valid_from' => $digitalSignature->valid_from->toISOString(),
                    'valid_until' => $digitalSignature->valid_until->toISOString(),
                    'is_valid' => $digitalSignature->isValid(),
                    'is_expiring_soon' => $digitalSignature->isExpiringSoon(),
                    'public_key_fingerprint' => $digitalSignature->getPublicKeyFingerprint(),
                    'creator' => [
                        'name' => $digitalSignature->creator->name,
                        'email' => $digitalSignature->creator->email
                    ],
                    'usage_stats' => $digitalSignature->getUsageStats(),
                    'created_at' => $digitalSignature->created_at->toISOString(),
                    'updated_at' => $digitalSignature->updated_at->toISOString()
                ]
            ]);

        } catch (\Exception $e) {
            Log::error('Signature details retrieval failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve signature details: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get list of signatures untuk dropdown/selection
     */
    public function getActiveSignatures()
    {
        try {
            $signatures = DigitalSignature::active()
                ->valid()
                ->select('id', 'signature_id', 'algorithm', 'key_length', 'signature_purpose', 'valid_until')
                ->get()
                ->map(function ($signature) {
                    return [
                        'id' => $signature->id,
                        'signature_id' => $signature->signature_id,
                        'label' => "{$signature->signature_purpose} ({$signature->algorithm}, {$signature->key_length}-bit)",
                        'algorithm' => $signature->algorithm,
                        'key_length' => $signature->key_length,
                        'expires_at' => $signature->valid_until->toISOString(),
                        'expires_in_days' => now()->diffInDays($signature->valid_until, false)
                    ];
                });

            return response()->json([
                'success' => true,
                'data' => $signatures
            ]);

        } catch (\Exception $e) {
            Log::error('Active signatures retrieval failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Failed to retrieve active signatures: ' . $e->getMessage()
            ], 500);
        }
    }
}
