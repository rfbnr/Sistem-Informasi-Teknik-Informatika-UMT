<?php

namespace App\Http\Controllers\DigitalSignature;

use Illuminate\Http\Request;
use App\Models\ApprovalRequest;
use App\Services\QRCodeService;
use App\Models\DigitalSignature;
use App\Models\DocumentSignature;
use Illuminate\Support\Facades\Log;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use App\Services\VerificationService;
use Illuminate\Database\QueryException;
use App\Services\DigitalSignatureService;
use Illuminate\Support\Facades\Validator;

class DigitalSignatureController extends Controller
{
    protected $digitalSignatureService;
    protected $qrCodeService;
    protected $verificationService;

    public function __construct(
        DigitalSignatureService $digitalSignatureService,
        QRCodeService $qrCodeService,
        VerificationService $verificationService
    ) {
        $this->digitalSignatureService = $digitalSignatureService;
        $this->qrCodeService = $qrCodeService;
        $this->verificationService = $verificationService;
    }

    /**
     * Admin dashboard untuk digital signature management
     */
    public function adminDashboard()
    {
        try {
            $stats = [
                'total_signatures' => DigitalSignature::count(),
                'active_signatures' => DigitalSignature::active()->count(),
                'expired_signatures' => DigitalSignature::where('valid_until', '<', now())->count(),
                'total_documents_signed' => DocumentSignature::count(),
                'pending_signatures' => DocumentSignature::where('signature_status', DocumentSignature::STATUS_PENDING)->count(),
                'verified_signatures' => DocumentSignature::where('signature_status', DocumentSignature::STATUS_VERIFIED)->count()
            ];

            $recentSignatures = DigitalSignature::with('creator')
                ->latest()
                ->limit(10)
                ->get();

            $expiringSignatures = DigitalSignature::expiringSoon(30)
                ->with('creator')
                ->get();

            $verificationStats = $this->verificationService->getVerificationStatistics();

            return view('digital-signature.admin.dashboard', compact(
                'stats',
                'recentSignatures',
                'expiringSignatures',
                'verificationStats'
            ));

        } catch (\Exception $e) {
            Log::error('Admin dashboard error: ' . $e->getMessage());
            return back()->with('error', 'Failed to load dashboard data');
        }
    }

    /**
     * Key management interface
     */
    public function keyManagement()
    {
        try {
            $signatures = DigitalSignature::with('creator')
                ->orderBy('created_at', 'desc')
                ->paginate(15);

            return view('digital-signature.admin.key-management', compact('signatures'));

        } catch (\Exception $e) {
            Log::error('Key management error: ' . $e->getMessage());
            return back()->with('error', 'Failed to load key management data');
        }
    }

    /**
     * Create new digital signature key
     */
    public function createSignatureKey(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'purpose' => 'required|string|max:255',
            'validity_years' => 'required|integer|min:1|max:10',
            'key_length' => 'required|integer|in:2048,3072,4096'
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator)->withInput();
        }

        try {
            $signature = $this->digitalSignatureService->createDigitalSignature(
                $request->purpose,
                Auth::id(),
                $request->validity_years
            );

            Log::info('Digital signature key created', [
                'signature_id' => $signature->signature_id,
                'created_by' => Auth::id()
            ]);

            return redirect()->route('admin.signature.keys.index')
                ->with('success', 'Digital signature key created successfully');

        } catch (QueryException $e) {
            Log::error('Database error during signature key creation: ' . $e->getMessage());
            return back()->with('error', 'Database error: ' . $e->getMessage());
        } catch (\RuntimeException $e) {
            Log::error('Runtime error during signature key creation: ' . $e->getMessage());
            return back()->with('error', 'Runtime error: ' . $e->getMessage());
        } catch (\LogicException $e) {
            Log::error('Logic error during signature key creation: ' . $e->getMessage());
            return back()->with('error', 'Logic error: ' . $e->getMessage());
        } catch (\Exception $e) {
            Log::error('Signature key creation failed: ' . $e->getMessage());
            return back()->with('error', 'Failed to create digital signature key: ' . $e->getMessage());
        }
    }

    /**
     * View signature key details
     */
    public function viewSignatureKey($id)
    {
        try {
            $signature = DigitalSignature::with('creator', 'documentSignatures')->findOrFail($id);
            $stats = $this->digitalSignatureService->getSignatureStatistics($id);

            return view('digital-signature.admin.key-details', compact('signature', 'stats'));

        } catch (\Exception $e) {
            Log::error('View signature key error: ' . $e->getMessage());
            return back()->with('error', 'Signature key not found');
        }
    }

    /**
     * Revoke signature key
     */
    public function revokeSignatureKey(Request $request, $id)
    {
        $validator = Validator::make($request->all(), [
            'reason' => 'required|string|max:500'
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator);
        }

        try {
            $this->digitalSignatureService->revokeSignature($id, $request->reason);

            return back()->with('success', 'Digital signature key revoked successfully');

        } catch (\Exception $e) {
            Log::error('Signature key revocation failed: ' . $e->getMessage());
            return back()->with('error', 'Failed to revoke signature key');
        }
    }

    /**
     * Document signing interface untuk user
     */
    public function signDocument($approvalRequestId)
    {
        try {
            $approvalRequest = ApprovalRequest::with('user')->findOrFail($approvalRequestId);

            // Check authorization
            if ($approvalRequest->user_id !== Auth::id()) {
                abort(403, 'Unauthorized to sign this document');
            }

            // Check if document is ready to be signed
            if (!$approvalRequest->canBeSignedByUser()) {
                return redirect()->route('digital-signature.user.signature.approval.status')
                    ->with('error', 'Document is not ready for signing');
            }

            // Get active digital signature
            $digitalSignature = DigitalSignature::active()->valid()->first();

            // dd($digitalSignature);

            if (!$digitalSignature) {
                return back()->with('error', 'No valid digital signature available for signing');
            }

            // Check if DocumentSignature already exists
            $documentSignature = DocumentSignature::where('approval_request_id', $approvalRequestId)->first();

            if (!$documentSignature) {
                // Create new DocumentSignature record
                $documentSignature = DocumentSignature::create([
                    'approval_request_id' => $approvalRequestId,
                    'digital_signature_id' => $digitalSignature->id,
                    'document_hash' => DocumentSignature::generateDocumentHash(
                        storage_path('app/' . $approvalRequest->document_path)
                    ),
                    'signed_by' => Auth::id(),
                    'signature_status' => DocumentSignature::STATUS_PENDING
                ]);
            }

            return view('digital-signature.user.sign-document', compact(
                'approvalRequest',
                'digitalSignature',
                'documentSignature'
            ));

        } catch (\Exception $e) {
            Log::error('Sign document interface error: ' . $e->getMessage());
            return back()->with('error', 'Failed to load signing interface');
        }
    }

    /**
     * Process document signing
     */
    public function processDocumentSigning(Request $request, $approvalRequestId)
    {
        $validator = Validator::make($request->all(), [
            'canvas_data' => 'required|string',
            'positioning_data' => 'required|array'
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => 'Invalid signing data'], 400);
        }

        try {
            $approvalRequest = ApprovalRequest::findOrFail($approvalRequestId);

            // Check authorization
            if ($approvalRequest->user_id !== Auth::id()) {
                return response()->json(['error' => 'Unauthorized'], 403);
            }

            // Get active digital signature
            $digitalSignature = DigitalSignature::active()->valid()->first();

            if (!$digitalSignature) {
                return response()->json(['error' => 'No valid digital signature available'], 400);
            }

            // Process signing
            $documentSignature = $this->digitalSignatureService->signApprovalRequest(
                $approvalRequestId,
                $digitalSignature->id
            );

            // Save canvas data
            $documentSignature->saveCanvasData(
                $request->canvas_data,
                $request->positioning_data
            );

            // Generate QR code
            $qrData = $this->qrCodeService->generateVerificationQR($documentSignature->id);

            Log::info('Document signed successfully', [
                'approval_request_id' => $approvalRequestId,
                'document_signature_id' => $documentSignature->id,
                'user_id' => Auth::id()
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Document signed successfully',
                'document_signature_id' => $documentSignature->id,
                'qr_code_url' => $qrData['qr_code_url'],
                'verification_url' => $qrData['verification_url']
            ]);

        } catch (\Exception $e) {
            Log::error('Document signing process failed: ' . $e->getMessage());
            return response()->json(['error' => 'Signing process failed'], 500);
        }
    }

    /**
     * Signature canvas interface
     */
    public function signatureCanvas($approvalRequestId)
    {
        try {
            $approvalRequest = ApprovalRequest::with('user')->findOrFail($approvalRequestId);

            // Check authorization
            if ($approvalRequest->user_id !== Auth::id()) {
                abort(403, 'Unauthorized');
            }

            $digitalSignature = DigitalSignature::active()->valid()->first();
            $documentSignature = DocumentSignature::where('approval_request_id', $approvalRequestId)->first();

            // Get signature template (default atau custom)
            $template = \App\Models\SignatureTemplate::default()->first();
            $canvasData = $template ? $template->generateCanvasData($documentSignature) : null;

            return view('digital-signature.components.signature-canvas', compact(
                'approvalRequest',
                'digitalSignature',
                'documentSignature',
                'canvasData'
            ));

        } catch (\Exception $e) {
            Log::error('Signature canvas error: ' . $e->getMessage());
            return back()->with('error', 'Failed to load signature canvas');
        }
    }

    /**
     * Verification tools untuk admin
     */
    public function verificationTools()
    {
        try {
            $recentVerifications = DocumentSignature::with(['approvalRequest', 'signer'])
                ->where('signature_status', DocumentSignature::STATUS_VERIFIED)
                ->latest('verified_at')
                ->limit(20)
                ->get();

            $verificationStats = $this->verificationService->getVerificationStatistics();

            return view('digital-signature.admin.verification-tools', compact(
                'recentVerifications',
                'verificationStats'
            ));

        } catch (\Exception $e) {
            Log::error('Verification tools error: ' . $e->getMessage());
            return back()->with('error', 'Failed to load verification tools');
        }
    }

    /**
     * Manual verification oleh admin
     */
    public function manualVerification(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'document_signature_id' => 'required|exists:document_signatures,id'
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator);
        }

        try {
            $verificationResult = $this->verificationService->verifyById($request->document_signature_id);

            if ($verificationResult['is_valid']) {
                // Update status jika valid
                $documentSignature = DocumentSignature::findOrFail($request->document_signature_id);
                $documentSignature->update([
                    'signature_status' => DocumentSignature::STATUS_VERIFIED,
                    'verified_at' => now(),
                    'verified_by' => Auth::id()
                ]);

                return back()->with('success', 'Document signature verified successfully');
            } else {
                return back()->with('error', 'Verification failed: ' . $verificationResult['message']);
            }

        } catch (\Exception $e) {
            Log::error('Manual verification failed: ' . $e->getMessage());
            return back()->with('error', 'Verification process failed');
        }
    }

    /**
     * Export signature statistics
     */
    public function exportStatistics(Request $request)
    {
        try {
            $period = $request->get('period', 30);
            $format = $request->get('format', 'json');

            $stats = $this->verificationService->getVerificationStatistics($period);

            // Add detailed signature data
            $signatures = DigitalSignature::with(['creator', 'documentSignatures'])
                ->where('created_at', '>=', now()->subDays($period))
                ->get();

            $exportData = [
                'period' => $period,
                'generated_at' => now(),
                'statistics' => $stats,
                'signatures' => $signatures->map(function ($signature) {
                    return [
                        'id' => $signature->id,
                        'signature_id' => $signature->signature_id,
                        'algorithm' => $signature->algorithm,
                        'status' => $signature->status,
                        'created_at' => $signature->created_at,
                        'valid_until' => $signature->valid_until,
                        'documents_signed' => $signature->documentSignatures->count(),
                        'creator' => $signature->creator->name ?? 'Unknown'
                    ];
                })
            ];

            if ($format === 'csv') {
                return $this->exportToCSV($exportData);
            }

            return response()->json($exportData);

        } catch (\Exception $e) {
            Log::error('Export statistics failed: ' . $e->getMessage());
            return response()->json(['error' => 'Export failed'], 500);
        }
    }

    /**
     * Generate test signature untuk development
     */
    public function generateTestSignature()
    {
        if (!app()->environment('local')) {
            abort(403, 'Test signatures only available in development environment');
        }

        try {
            $signature = $this->digitalSignatureService->createDigitalSignature(
                'Test Signature - Development',
                Auth::id(),
                1
            );

            return response()->json([
                'success' => true,
                'signature_id' => $signature->signature_id,
                'message' => 'Test signature created successfully'
            ]);

        } catch (\Exception $e) {
            return response()->json(['error' => 'Test signature creation failed'], 500);
        }
    }

    /**
     * Export data to CSV format
     */
    private function exportToCSV($data)
    {
        $filename = 'signature_statistics_' . date('Y-m-d_H-i-s') . '.csv';

        $headers = [
            'Content-Type' => 'text/csv',
            'Content-Disposition' => 'attachment; filename="' . $filename . '"'
        ];

        $callback = function() use ($data) {
            $handle = fopen('php://output', 'w');

            // CSV headers
            fputcsv($handle, [
                'Signature ID',
                'Algorithm',
                'Status',
                'Created At',
                'Valid Until',
                'Documents Signed',
                'Creator'
            ]);

            // CSV data
            foreach ($data['signatures'] as $signature) {
                fputcsv($handle, [
                    $signature['signature_id'],
                    $signature['algorithm'],
                    $signature['status'],
                    $signature['created_at'],
                    $signature['valid_until'],
                    $signature['documents_signed'],
                    $signature['creator']
                ]);
            }

            fclose($handle);
        };

        return response()->stream($callback, 200, $headers);
    }
}
