worker_processes auto;
events {
    worker_connections 1024;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;
  types_hash_max_size 4096;
  include       mime.types;
  default_type  application/octet-stream;

  # -------- gzip untuk aset teks --------
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_vary on;
  gzip_proxied any;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/xml+rss
    image/svg+xml
    font/ttf
    font/otf
    application/vnd.ms-fontobject
    application/font-woff2
    application/font-woff;
  # (Sengaja TIDAK gzip png/jpg/pdf karena sudah terkompres)

  # -------- redirect HTTP -> HTTPS (honor proxy) --------
  # Railway menambahkan X-Forwarded-Proto: http/https
  map $http_x_forwarded_proto $redirect_https {
    default 0;
    https   0;
    http    1;
    ""      0;
  }

  server {
    listen 8080;
    server_name _;

    root /app/public;
    index index.php index.html;

    # --- Redirect ke HTTPS jika datangnya http di edge ---
    if ($redirect_https) {
      return 301 https://$host$request_uri;
    }

    # --- Header keamanan dasar ---
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;
    add_header X-XSS-Protection "1; mode=block" always;

    # HSTS opsional (aktifkan kalau domain kamu sudah full HTTPS stabil)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # --- Aset Vite (hashed) → cache 1 tahun immutable ---
    location /build/ {
      try_files $uri =404;
      access_log off;
      expires 1y;
      add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    # --- File publik (PDF/PNG/dll) di public/storage → cache 7 hari ---
    # symlink: public/storage -> storage/app/public
    location /storage/ {
      alias /app/storage/app/public/;
      access_log off;

      # Cache: 7 hari untuk dokumen/gambar
      expires 7d;
      add_header Cache-Control "public, max-age=604800, stale-while-revalidate=86400" always;

      # PDF ditampilkan inline di browser
      types {
        application/pdf pdf;
      }
      add_header Content-Disposition "inline" always;
    }

    # --- Laravel routes ---
    location / {
      try_files $uri $uri/ /index.php?$query_string;
    }

    # --- PHP-FPM ---
    location ~ \.php$ {
      include fastcgi_params;
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
      fastcgi_param PATH_INFO $fastcgi_path_info;
      fastcgi_pass 127.0.0.1:9000;
      fastcgi_index index.php;
      fastcgi_read_timeout 300;
    }

    # --- Lindungi file sensitif ---
    location ~* \.(env|log|ini|sh|sql|git|hg|svn)$ {
      deny all;
    }

    client_max_body_size 32m;
  }
}
